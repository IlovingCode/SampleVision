import ARKit
import RealityKit

class Grid: Entity, HasModel, HasAnchoring, HasCollision {
    var myAnchor: ARAnchor
    var planeGeometry: MeshResource!
    var isShowingModel: Bool = false
    var pose:SIMD3<Float> = [0, 0, 0]
    
    init(anchor: ARAnchor) {
        self.myAnchor = anchor
        super.init()
        self.didSetup()
    }
    
    func genAnchorPlane(anchor: ARAnchor) {
        if let plane = anchor as? ARPlaneAnchor {
            self.planeGeometry = .generatePlane(width: plane.extent.x,
                                               depth: plane.extent.z,
                                               cornerRadius: 0.5)
            
            self.name = "xxx"
            self.pose = [plane.center.x, 0, plane.center.z]
        }
        
        if let image = anchor as? ARImageAnchor {
            self.planeGeometry = .generatePlane(width: Float(image.referenceImage.physicalSize.width),
                                               depth: Float(image.referenceImage.physicalSize.height),
                                               cornerRadius: 0.5)
            
            self.name = image.referenceImage.name ?? "xxx"
            self.pose = [image.transform[0][3], 0, image.transform[2][3]]
        }
    }
        
    fileprivate func didSetup() {
//        self.name = "planeEntity"
        genAnchorPlane(anchor: myAnchor)
        let model = generatePlaneModel()
        self.addChild(model)
        self.generateCollisionShapes(recursive: true)
    }
    
    open func didUpdate(anchor: ARAnchor) {
        genAnchorPlane(anchor: anchor)
        for childEntity in self.children {
            childEntity.position = pose
        }
    }
    required init() { fatalError("Hasn't been implemented yet") }
    
    
    func generatePlaneModel() -> ModelEntity {
        var material = UnlitMaterial()
        if #available(iOS 15.0, *) {
            let frameworkBundle = Bundle(for: ArViewerViewManager.self)
            let bundleURL = frameworkBundle.resourceURL?.appendingPathComponent("ArViewerBundle.bundle")
            let resourceBundle = Bundle(url: bundleURL!)
            let resourceUrl = resourceBundle?.url(forResource: "grid", withExtension: "png")
            material.color = .init(tint: .white.withAlphaComponent(0.9999),
                                   texture: .init(try! .load(contentsOf: resourceUrl!)))
        }
        
        let model = ModelEntity(mesh: planeGeometry, materials: [material])
        model.position = pose
        model.name = "plane"
        return model
    }
    
    
    func replaceModel(model: Entity) {
        // remove all children
        children.removeAll()
        model.name = "model"
        self.addChild(model)
        self.generateCollisionShapes(recursive: true)
        isShowingModel = true
        
        for animation in model.availableAnimations {
            if #available(iOS 15.0, *) {
                model.playAnimation(animation.repeat())
            } else {
                // Fallback on earlier versions
            }
        }
    }
    
    // reset the plane
    func reset() {
        children.removeAll()
        let model = generatePlaneModel()
        addChild(model)
        generateCollisionShapes(recursive: true)
        isShowingModel = false
    }
}
